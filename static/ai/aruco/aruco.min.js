var AR=AR||{};AR.Marker=function(a,h){this.id=a;this.corners=h};AR.Detector=function(){this.grey=new CV.Image;this.thres=new CV.Image;this.homography=new CV.Image;this.binary=[];this.contours=[];this.polys=[];this.candidates=[]};
AR.Detector.prototype.detect=function(a){CV.grayscale(a,this.grey);CV.adaptiveThreshold(this.grey,this.thres,2,3);this.contours=CV.findContours(this.thres,this.binary);this.candidates=this.findCandidates(this.contours,.01*a.width,.05,10);this.candidates=this.clockwiseCorners(this.candidates);this.candidates=this.notTooNear(this.candidates,10);return this.findMarkers(this.grey,this.candidates,49)};
AR.Detector.prototype.findCandidates=function(a,h,b,d){var f=[],e=a.length,g;this.polys=[];for(g=0;g<e;++g){var c=a[g];c.length>=h&&(c=CV.approxPolyDP(c,c.length*b),this.polys.push(c),4===c.length&&CV.isContourConvex(c)&&CV.minEdgeLength(c)>=d&&f.push(c))}return f};
AR.Detector.prototype.clockwiseCorners=function(a){var h=a.length,b;for(b=0;b<h;++b){var d=a[b][1].x-a[b][0].x;var f=a[b][1].y-a[b][0].y;var e=a[b][2].x-a[b][0].x;var g=a[b][2].y-a[b][0].y;0>d*g-f*e&&(d=a[b][1],a[b][1]=a[b][3],a[b][3]=d)}return a};
AR.Detector.prototype.notTooNear=function(a,h){var b=[],d=a.length,f,e,g,c;for(e=0;e<d;++e)for(g=e+1;g<d;++g){for(c=f=0;4>c;++c){var k=a[e][c].x-a[g][c].x;var l=a[e][c].y-a[g][c].y;f+=k*k+l*l}f/4<h*h&&(CV.perimeter(a[e])<CV.perimeter(a[g])?a[e].tooNear=!0:a[g].tooNear=!0)}for(e=0;e<d;++e)a[e].tooNear||b.push(a[e]);return b};
AR.Detector.prototype.findMarkers=function(a,h,b){var d=[],f=h.length,e;for(e=0;e<f;++e){var g=h[e];CV.warp(a,this.homography,g,b);CV.threshold(this.homography,this.homography,CV.otsu(this.homography));(g=this.getMarker(this.homography,g))&&d.push(g)}return d};
AR.Detector.prototype.getMarker=function(a,h){var b=a.width/7>>>0;var d=b*b>>1;var f=[],e=[],g=[],c,k;for(c=0;7>c;++c){var l=0===c||6===c?1:6;for(k=0;7>k;k+=l){var m={x:k*b,y:c*b,width:b,height:b};if(CV.countNonZero(a,m)>d)return null}}for(c=0;5>c;++c)for(f[c]=[],k=0;5>k;++k)m={x:(k+1)*b,y:(c+1)*b,width:b,height:b},f[c][k]=CV.countNonZero(a,m)>d?1:0;e[0]=f;g[0]=this.hammingDistance(e[0]);b=g[0];d=0;for(c=1;4>c;++c)e[c]=this.rotate(e[c-1]),g[c]=this.hammingDistance(e[c]),g[c]<b&&(b=g[c],d=c);return 0!==
b?null:new AR.Marker(this.mat2id(e[d]),this.rotate2(h,4-d))};AR.Detector.prototype.hammingDistance=function(a){var h=[[1,0,0,0,0],[1,0,1,1,1],[0,1,0,0,1],[0,1,1,1,0]],b=0,d,f,e,g;for(f=0;5>f;++f){var c=Infinity;for(e=0;4>e;++e){for(g=d=0;5>g;++g)d+=a[f][g]===h[e][g]?0:1;d<c&&(c=d)}b+=c}return b};AR.Detector.prototype.mat2id=function(a){var h=0,b;for(b=0;5>b;++b)h<<=1,h|=a[b][1],h<<=1,h|=a[b][3];return h};
AR.Detector.prototype.rotate=function(a){var h=[],b=a.length,d,f;for(d=0;d<b;++d)for(h[d]=[],f=0;f<a[d].length;++f)h[d][f]=a[a[d].length-f-1][d];return h};AR.Detector.prototype.rotate2=function(a,h){var b=[],d=a.length,f;for(f=0;f<d;++f)b[f]=a[(h+f)%d];return b};